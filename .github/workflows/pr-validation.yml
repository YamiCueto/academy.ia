# ğŸ” Pull Request Validation Pipeline
# Automated validation for Pull Requests

name: ğŸ” PR Validation

# ğŸ¯ Triggers - Solo en Pull Requests
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

# ğŸ“‹ Jobs Definition
jobs:
  # ğŸ” Code Review & Validation
  pr-validation:
    name: ğŸ” PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout PR
      uses: actions/checkout@v5
      with:
        # Checkout the PR branch
        ref: ${{ github.event.pull_request.head.sha }}
        
    - name: ğŸ“Š Analyze Changes
      run: |
        echo "ğŸ” Analyzing Pull Request changes..."
        echo "ğŸ“ PR Title: ${{ github.event.pull_request.title }}"
        echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
        echo "ğŸŒ¿ Branch: ${{ github.event.pull_request.head.ref }}"
        
        # Show changed files
        echo "ğŸ“„ Changed files:"
        git diff --name-only HEAD~1 HEAD || echo "Unable to show diff"
        
    - name: ğŸ”§ Validate Structure
      run: |
        echo "ğŸ”§ Validating project structure..."
        
        # Check essential files
        echo "ğŸ“„ Checking essential files..."
        test -f index.html && echo "âœ… index.html exists" || echo "âŒ index.html missing"
        test -f README.md && echo "âœ… README.md exists" || echo "âŒ README.md missing"
        
        # Check assets structure
        echo "ğŸ“ Checking assets structure..."
        test -d assets && echo "âœ… assets/ exists" || echo "âŒ assets/ missing"
        test -d assets/css && echo "âœ… assets/css/ exists" || echo "âŒ assets/css/ missing"
        test -d assets/js && echo "âœ… assets/js/ exists" || echo "âŒ assets/js/ missing"
        
        echo "âœ… Structure validation completed!"
        
    - name: ğŸ¨ CSS Validation
      run: |
        echo "ğŸ¨ Validating CSS files..."
        
        # Check for CSS syntax issues (basic check)
        for file in assets/css/*.css; do
          if [ -f "$file" ]; then
            echo "ğŸ” Checking $file..."
            # Basic syntax check - look for unclosed braces
            if grep -q '{' "$file" && grep -q '}' "$file"; then
              echo "âœ… $file appears syntactically valid"
            else
              echo "âš ï¸ $file might have syntax issues"
            fi
          fi
        done
        
        echo "âœ… CSS validation completed!"
        
    - name: âš¡ JavaScript Validation
      run: |
        echo "âš¡ Validating JavaScript files..."
        
        # Check for ES6 modules
        for file in assets/js/**/*.js; do
          if [ -f "$file" ]; then
            echo "ğŸ” Checking $file..."
            # Check for module syntax
            if grep -q "import\|export" "$file"; then
              echo "âœ… $file uses ES6 modules"
            else
              echo "ğŸ“„ $file is a regular JS file"
            fi
          fi
        done
        
        echo "âœ… JavaScript validation completed!"
        
    - name: ğŸ“± Mobile Compatibility Check
      run: |
        echo "ğŸ“± Checking mobile compatibility..."
        
        # Check for responsive design
        echo "ğŸ” Checking for responsive CSS..."
        if grep -r "@media" assets/css/; then
          echo "âœ… Responsive CSS found"
        else
          echo "âš ï¸ No responsive CSS detected"
        fi
        
        # Check for viewport meta
        if grep -q 'name="viewport"' index.html; then
          echo "âœ… Viewport meta tag found"
        else
          echo "âš ï¸ Viewport meta tag missing"
        fi
        
        # Check for touch-friendly elements
        if grep -r "min-height.*4[48]px\|touch-action\|pointer-events" assets/css/; then
          echo "âœ… Touch-friendly CSS found"
        else
          echo "ğŸ“± Consider adding touch-friendly styles"
        fi
        
        echo "âœ… Mobile compatibility check completed!"
        
    - name: â™¿ Accessibility Check
      run: |
        echo "â™¿ Checking accessibility features..."
        
        # Check for ARIA attributes
        if grep -q "aria-\|role=" index.html; then
          echo "âœ… ARIA attributes found"
        else
          echo "âš ï¸ Consider adding ARIA attributes"
        fi
        
        # Check for semantic HTML
        if grep -q "<main>\|<header>\|<nav>\|<section>" index.html; then
          echo "âœ… Semantic HTML elements found"
        else
          echo "âš ï¸ Consider using semantic HTML elements"
        fi
        
        # Check for alt attributes (basic check)
        if grep -q 'alt=' index.html; then
          echo "âœ… Alt attributes found"
        else
          echo "ğŸ“· No images or alt attributes found"
        fi
        
        echo "âœ… Accessibility check completed!"
        
    - name: ğŸ“Š Performance Check
      run: |
        echo "ğŸ“Š Basic performance checks..."
        
        # Check file sizes
        echo "ğŸ“ Checking asset sizes..."
        find assets -type f -name "*.css" -exec wc -c {} + 2>/dev/null | tail -1 | awk '{print "ğŸ“„ Total CSS size: " $1 " bytes"}'
        find assets -type f -name "*.js" -exec wc -c {} + 2>/dev/null | tail -1 | awk '{print "âš¡ Total JS size: " $1 " bytes"}'
        
        # Check for performance best practices
        echo "ğŸ” Checking for performance optimizations..."
        if grep -q "preconnect\|prefetch\|preload" index.html; then
          echo "âœ… Resource hints found"
        else
          echo "ğŸ’¡ Consider adding resource hints (preconnect, prefetch, preload)"
        fi
        
        echo "âœ… Performance check completed!"
        
    - name: âœ… PR Summary
      run: |
        echo "ğŸ“‹ PULL REQUEST VALIDATION SUMMARY"
        echo "================================="
        echo "ğŸ¯ PR: ${{ github.event.pull_request.title }}"
        echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
        echo "ğŸŒ¿ Branch: ${{ github.event.pull_request.head.ref }} â†’ main"
        echo "ğŸ” Validation: âœ… Completed"
        echo "ğŸ“… Date: $(date)"
        echo "================================="
        echo ""
        echo "ğŸ‰ All validations completed successfully!"
        echo "ğŸ‘ This PR is ready for review!"

  # ğŸ“ Auto-label PR based on changes
  auto-label:
    name: ğŸ·ï¸ Auto Label PR
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
    - name: ğŸ“‚ Checkout PR
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        
    - name: ğŸ·ï¸ Label PR Based on Changes
      run: |
        echo "ğŸ·ï¸ Analyzing changes to apply appropriate labels..."
        
        # Get changed files
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        echo "ğŸ“„ Changed files: $CHANGED_FILES"
        
        # Determine labels based on changed files
        LABELS=""
        
        if echo "$CHANGED_FILES" | grep -q "\.css$"; then
          LABELS="$LABELS,css,design"
        fi
        
        if echo "$CHANGED_FILES" | grep -q "\.js$"; then
          LABELS="$LABELS,javascript,functionality"
        fi
        
        if echo "$CHANGED_FILES" | grep -q "\.html$"; then
          LABELS="$LABELS,html,frontend"
        fi
        
        if echo "$CHANGED_FILES" | grep -q "README\.md"; then
          LABELS="$LABELS,documentation"
        fi
        
        if echo "$CHANGED_FILES" | grep -q "responsive\.css\|@media"; then
          LABELS="$LABELS,mobile,responsive"
        fi
        
        if echo "$CHANGED_FILES" | grep -q "\.github/"; then
          LABELS="$LABELS,ci-cd,github-actions"
        fi
        
        # Clean up labels (remove leading comma)
        LABELS=$(echo "$LABELS" | sed 's/^,//')
        
        echo "ğŸ·ï¸ Suggested labels: $LABELS"
        echo "labels=$LABELS" >> $GITHUB_OUTPUT