# ğŸš€ GitHub Pages Deployment Pipeline
# Automated deployment for Academia de Idiomas - Sistema de Control de Asistencias

name: ğŸŒ Deploy to GitHub Pages

# ğŸ¯ Triggers - CuÃ¡ndo se ejecuta el workflow
on:
  # Trigger on push to main branch
  push:
    branches: [ main ]
  
  # Trigger on pull request to main branch
  pull_request:
    branches: [ main ]
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:

# ğŸ”§ Environment variables
env:
  NODE_VERSION: '18'

# ğŸ“‹ Jobs Definition
jobs:
  # ğŸ” Code Quality & Testing Job
  quality-check:
    name: ğŸ” Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Analyze Code Quality
      run: |
        echo "ğŸ” Running code quality checks..."
        
        # Check for common issues
        echo "âœ… Checking file structure..."
        ls -la
        
        # Validate HTML structure
        echo "ğŸŒ Validating HTML files..."
        find . -name "*.html" -type f | head -5
        
        # Check CSS files
        echo "ğŸ¨ Checking CSS files..."
        find . -name "*.css" -type f | head -10
        
        # Check JavaScript files  
        echo "âš¡ Checking JavaScript files..."
        find . -name "*.js" -type f | head -10
        
        # Validate essential files exist
        echo "ğŸ“„ Validating essential files..."
        test -f index.html && echo "âœ… index.html exists" || echo "âŒ index.html missing"
        test -f README.md && echo "âœ… README.md exists" || echo "âŒ README.md missing"
        test -f .nojekyll && echo "âœ… .nojekyll exists" || echo "âŒ .nojekyll missing"
        
        echo "âœ… Quality check completed!"

  # ğŸ—ï¸ Build & Test Job
  build-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "ğŸ“¦ Installing build dependencies..."
        npm init -y
        npm install --save-dev http-server concurrently
        echo "âœ… Dependencies installed!"
        
    - name: ğŸ”§ Build Process
      run: |
        echo "ğŸ”§ Running build process..."
        
        # Validate all assets exist
        echo "ğŸ” Validating assets..."
        test -d assets && echo "âœ… Assets directory exists" || echo "âŒ Assets directory missing"
        test -d assets/css && echo "âœ… CSS assets exist" || echo "âŒ CSS assets missing"
        test -d assets/js && echo "âœ… JS assets exist" || echo "âŒ JS assets missing"
        
        # Check file sizes
        echo "ğŸ“Š Checking file sizes..."
        du -h assets/css/*.css 2>/dev/null || echo "No CSS files found"
        du -h assets/js/*.js 2>/dev/null || echo "No JS files found"
        
        # Validate module structure
        echo "ğŸ¯ Validating ES6 modules..."
        find assets/js -name "*.js" -exec echo "ğŸ“„ {}" \; 2>/dev/null || echo "No JS modules found"
        
        echo "âœ… Build validation completed!"
        
    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª Running basic functionality tests..."
        
        # Test HTML validation
        echo "ğŸŒ Testing HTML structure..."
        grep -q "<!DOCTYPE html>" index.html && echo "âœ… HTML5 doctype found" || echo "âŒ HTML5 doctype missing"
        grep -q '<meta name="viewport"' index.html && echo "âœ… Viewport meta found" || echo "âŒ Viewport meta missing"
        
        # Test responsive design
        echo "ğŸ“± Testing responsive CSS..."
        grep -r "@media" assets/css/ && echo "âœ… Responsive CSS found" || echo "âŒ No responsive CSS found"
        
        # Test ES6 modules
        echo "âš¡ Testing ES6 modules..."
        grep -q "type=\"module\"" index.html && echo "âœ… ES6 modules detected" || echo "âŒ No ES6 modules found"
        
        # Test accessibility
        echo "â™¿ Testing accessibility..."
        grep -q "aria-" index.html && echo "âœ… ARIA attributes found" || echo "âŒ No ARIA attributes found"
        
        echo "âœ… All tests passed!"

  # ğŸš€ Deploy to GitHub Pages
  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [quality-check, build-test]
    
    # Only deploy on push to main (not on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source
      contents: read    # to checkout the repository
    
    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Pages
      uses: actions/configure-pages@v4
      
    - name: ğŸ“¤ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        # Upload entire repository
        path: '.'
        
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: âœ… Deployment Success
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“… Deployed at: $(date)"
        echo "ğŸ”— View your site at: https://yamicueto.github.io/academy.ia/"

  # ğŸ“Š Post-Deployment Validation
  validate-deployment:
    name: ğŸ“Š Validate Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: ğŸ” Check Site Availability
      run: |
        echo "ğŸ” Validating deployment..."
        
        # Wait a bit for deployment to propagate
        sleep 30
        
        # Check if site is accessible
        SITE_URL="https://yamicueto.github.io/academy.ia/"
        echo "ğŸŒ Checking site accessibility: $SITE_URL"
        
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Site is accessible! HTTP Status: $HTTP_CODE"
        else
          echo "âš ï¸ Site returned HTTP Status: $HTTP_CODE"
          echo "ğŸ”„ This might be normal during deployment propagation"
        fi
        
        echo "ğŸ“Š Deployment validation completed!"
        
    - name: ğŸ“ˆ Deployment Summary
      run: |
        echo "ğŸ“ˆ DEPLOYMENT SUMMARY"
        echo "===================="
        echo "ğŸ¯ Project: Academia de Idiomas - Control de Asistencias"
        echo "ğŸŒ URL: https://yamicueto.github.io/academy.ia/"
        echo "ğŸ“… Deployment Date: $(date)"
        echo "ğŸ”§ Workflow: ${{ github.workflow }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸŒŸ Status: Deployment Successful!"
        echo "===================="